#####################################################################
# 	Hardware
#####################################################################

[include steppers.cfg]
#[include calibrate_z.cfg]
[include kiauh_macros.cfg]
[include probing.cfg]
[include heaters_fans.cfg]
[include input_shaper.cfg]
[include Tool_Head.cfg]
[include Fan_Monitor.cfg]

#####################################################################
# 	Macros
#####################################################################

#[include klicky_probe.cfg]
[include bedfans_dualcontrol.cfg]
[include nozzle_scrub.cfg]
[include stealthburner_leds.cfg]
[include macros.cfg]
[include bed_mesh.cfg]
[include pause_resume.cfg]
[include print_macros.cfg]
[include KAMP_Settings.cfg]
[include Adaptive_Meshing.cfg]
[include Line_Purge.cfg]
[include K-ShakeTune/*.cfg]
[include config_backup.cfg]

#####################################################################
# 	Kinematics
#####################################################################

[printer]
kinematics: corexy
max_velocity: 1000
max_accel: 6000		#Max 4000
max_accel_to_decel: 3000
max_z_velocity: 15 			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_D50F920C4E4B333448202020FF0A0E24-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 21.953 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
z_settling_time: 1000

#############################################
# Enable to SET_KINEMATIC_POSITION for Z hop
[force_move]
enable_force_move: True

#################
# Homing Override
[homing_override]
axes: xyz
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  {% if home_all or 'X' in params or 'Y' in params %} #Always Home X&Y together
    _HOME_XY
  {% endif %}
  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}

[gcode_macro _HOME_XY]

[gcode_macro _HOME_XY]
gcode:
    {% if not 'Z' in printer.toolhead.homed_axes %}
      # Set Z to 0 if not homed
      SET_KINEMATIC_POSITION Z=0
    {% endif %}

    # Z hop before homing
    G1 Z10 F600
    G28 Y
    G0 Y175 F10000
    G28 X

[gcode_macro _HOME_Z]
gcode:
    # Check if X&Y are homed
    {% if not 'xy' in printer.toolhead.homed_axes %} 
      { action_respond_info("X & Y not Homed, Forcing Full G28") }
      SET_KINEMATIC_POSITION Z=0
      G1 Z10 F600
      G28 Y
      G0 Y175 F10000
      G28 X
    {% endif %}
    G0 Y175 F10000
    G0 X175 F10000
    G28 Z
    G1 Z10


  
#[safe_z_home]
#home_xy_position: 175, 175 # update for your machine
#z_hop: 3

[respond]

[idle_timeout]
timeout: 14400

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[exclude_object]

#[filament_switch_sensor filament_sensor]
#switch_pin: ^PG12
#pause_on_runout: True
#insert_gcode:
#    M117 Insert Detected
#runout_gcode:
#    M117 Runout Detected

[filament_motion_sensor filament_sensor]
detection_length: 10
extruder: extruder
switch_pin: ^PG12
pause_on_runout: True
insert_gcode:
    M117 Insert Detected
    status_printing
runout_gcode:
    M117 Runout Detected
    status_error  # Turn LEDs red

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0


#####################################################################
#   LED Control
#####################################################################

## Chamber Lighting - HE2 Connector (Optional)
[output_pin caselight]
pin: PA2
pwm:true
shutdown_value: 0
value:1
cycle_time: 0.001

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 38.838
#*# pid_ki = 1.221
#*# pid_kd = 308.765
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.623
#*# pid_ki = 2.316
#*# pid_kd = 60.238
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.077758, 0.090513, 0.085388, 0.090060, 0.083876, 0.087944, 0.080501, 0.071551, 0.068126, 0.064421, 0.059116, 0.055535, 0.051862, 0.050567, 0.068755
#*# 	  0.079971, 0.084765, 0.083602, 0.081689, 0.080313, 0.077992, 0.076324, 0.073549, 0.070242, 0.066186, 0.061347, 0.057178, 0.059588, 0.053392, 0.059040
#*# 	  0.084110, 0.083430, 0.081584, 0.079366, 0.077129, 0.075079, 0.073306, 0.067325, 0.066990, 0.060248, 0.057955, 0.051202, 0.051881, 0.048123, 0.052365
#*# 	  0.077227, 0.082484, 0.072983, 0.077698, 0.068106, 0.069403, 0.063542, 0.064004, 0.056869, 0.056283, 0.047615, 0.048859, 0.042897, 0.046839, 0.044509
#*# 	  0.076441, 0.071533, 0.071109, 0.065560, 0.069164, 0.060235, 0.064494, 0.055388, 0.057311, 0.046930, 0.048809, 0.039656, 0.044033, 0.037027, 0.044791
#*# 	  0.069220, 0.069244, 0.064227, 0.065042, 0.059704, 0.059670, 0.051793, 0.054399, 0.045062, 0.045974, 0.035831, 0.038191, 0.029407, 0.035808, 0.029523
#*# 	  0.062214, 0.054321, 0.056991, 0.048998, 0.053146, 0.048054, 0.048799, 0.043368, 0.042113, 0.034408, 0.032516, 0.026294, 0.026106, 0.022035, 0.023752
#*# 	  0.048293, 0.045634, 0.044133, 0.042565, 0.040789, 0.040972, 0.037316, 0.035784, 0.030937, 0.027218, 0.020822, 0.019482, 0.012475, 0.013437, 0.011037
#*# 	  0.038136, 0.034485, 0.033405, 0.032290, 0.031338, 0.030010, 0.027188, 0.024204, 0.020553, 0.015866, 0.009637, 0.006142, 0.001089, -0.000297, -0.002487
#*# 	  0.029554, 0.027784, 0.026748, 0.025890, 0.024745, 0.023059, 0.021585, 0.018148, 0.015536, 0.009992, 0.006013, 0.000465, -0.003852, -0.007566, -0.008070
#*# 	  0.025669, 0.025360, 0.023031, 0.022153, 0.020507, 0.020643, 0.018019, 0.015491, 0.011212, 0.006882, 0.001385, -0.003369, -0.008436, -0.010452, -0.012855
#*# 	  0.024020, 0.022729, 0.020403, 0.019899, 0.018355, 0.017716, 0.016215, 0.012914, 0.009696, 0.005040, -0.000487, -0.005500, -0.010134, -0.014297, -0.015344
#*# 	  0.024881, 0.022944, 0.020623, 0.018994, 0.017713, 0.016834, 0.015560, 0.012591, 0.009252, 0.003827, -0.001793, -0.007041, -0.012367, -0.016069, -0.016990
#*# tension = 0.2
#*# min_x = 137.841
#*# algo = bicubic
#*# y_count = 13
#*# mesh_y_pps = 2
#*# min_y = 141.918
#*# x_count = 15
#*# max_y = 208.082
#*# mesh_x_pps = 2
#*# max_x = 212.159
#*#
#*# [beacon model default]
#*# model_coef = 1.4932847207145445,
#*# 	  1.813087807762665,
#*# 	  0.7366414453603123,
#*# 	  0.3563491168806203,
#*# 	  0.3852608157240816,
#*# 	  0.34424757540113665,
#*# 	  -0.26878256853592825,
#*# 	  -0.3108931011339748,
#*# 	  0.25378617562176914,
#*# 	  0.19890986381416514
#*# model_domain = 3.2251538094536715e-07,3.3508521240797756e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.134019
#*# model_offset = -0.82000
