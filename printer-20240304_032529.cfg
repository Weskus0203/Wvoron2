#####################################################################
# 	Hardware
#####################################################################

[include steppers.cfg]
#[include calibrate_z.cfg]
[include kiauh_macros.cfg]
[include probing.cfg]
[include heaters_fans.cfg]
[include input_shaper.cfg]
[include Tool_Head.cfg]
[include Fan_Monitor.cfg]

#####################################################################
# 	Macros
#####################################################################

#[include klicky_probe.cfg]
[include bedfans_dualcontrol.cfg]
[include nozzle_scrub.cfg]
[include stealthburner_leds.cfg]
[include macros.cfg]
[include bed_mesh.cfg]
[include pause_resume.cfg]
[include print_macros.cfg]
[include KAMP_Settings.cfg]
[include Adaptive_Meshing.cfg]
[include Line_Purge.cfg]
[include K-ShakeTune/*.cfg]
[include config_backup.cfg]

#####################################################################
# 	Kinematics
#####################################################################

[printer]
kinematics: corexy
max_velocity: 1000
max_accel: 6000		#Max 4000
max_accel_to_decel: 3000
max_z_velocity: 15 			#Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 350
square_corner_velocity: 5.0

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevD_D50F920C4E4B333448202020FF0A0E24-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 21.953 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
z_settling_time: 1000

#############################################
# Enable to SET_KINEMATIC_POSITION for Z hop
[force_move]
enable_force_move: True

#################
# Homing Override
[homing_override]
axes: xyz
gcode:
  {% set home_all = 'X' not in params and 'Y' not in params and 'Z' not in params %}
  {% if home_all or 'X' in params or 'Y' in params %} #Always Home X&Y together
    _HOME_XY
  {% endif %}
  {% if home_all or 'Z' in params %}
    _HOME_Z
  {% endif %}

[gcode_macro _HOME_XY]

[gcode_macro _HOME_XY]
gcode:
    {% if not 'Z' in printer.toolhead.homed_axes %}
      # Set Z to 0 if not homed
      SET_KINEMATIC_POSITION Z=0
    {% endif %}

    # Z hop before homing
    G1 Z10 F600
    G28 Y
    G0 Y175 F10000
    G28 X

[gcode_macro _HOME_Z]
gcode:
    # Check if X&Y are homed
    {% if not 'xy' in printer.toolhead.homed_axes %} 
      { action_respond_info("X & Y not Homed, Forcing Full G28") }
      SET_KINEMATIC_POSITION Z=0
      G1 Z10 F600
      G28 Y
      G0 Y175 F10000
      G28 X
    {% endif %}
    G0 Y175 F10000
    G0 X175 F10000
    G28 Z
    G1 Z10


  
#[safe_z_home]
#home_xy_position: 175, 175 # update for your machine
#z_hop: 3

[respond]

[idle_timeout]
timeout: 14400

[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[exclude_object]

#[filament_switch_sensor filament_sensor]
#switch_pin: ^PG12
#pause_on_runout: True
#insert_gcode:
#    M117 Insert Detected
#runout_gcode:
#    M117 Runout Detected

[filament_motion_sensor filament_sensor]
detection_length: 10
extruder: extruder
switch_pin: ^PG12
pause_on_runout: True
insert_gcode:
    M117 Insert Detected
    status_printing
runout_gcode:
    M117 Runout Detected
    status_error  # Turn LEDs red

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration: 1
gcode:
    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0


#####################################################################
#   LED Control
#####################################################################

## Chamber Lighting - HE2 Connector (Optional)
[output_pin caselight]
pin: PA2
pwm:true
shutdown_value: 0
value:1
cycle_time: 0.001

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 38.838
#*# pid_ki = 1.221
#*# pid_kd = 308.765
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.623
#*# pid_ki = 2.316
#*# pid_kd = 60.238
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.085044, 0.081932, 0.079725, 0.077408, 0.073217, 0.070407, 0.067706, 0.067290, 0.062869, 0.062677, 0.061130, 0.059843, 0.055972, 0.052710, 0.051544, 0.050218
#*# 	  0.080614, 0.079374, 0.076948, 0.073579, 0.070914, 0.067462, 0.063461, 0.064584, 0.063447, 0.062904, 0.060577, 0.057695, 0.053889, 0.051720, 0.047232, 0.046290
#*# 	  0.076932, 0.075094, 0.072357, 0.069690, 0.067040, 0.063871, 0.062750, 0.063369, 0.064257, 0.064073, 0.060738, 0.055925, 0.051336, 0.045784, 0.042797, 0.042355
#*# 	  0.068177, 0.065995, 0.064530, 0.061029, 0.057940, 0.056038, 0.055837, 0.057106, 0.059482, 0.057350, 0.053540, 0.046702, 0.040995, 0.035215, 0.032931, 0.033157
#*# 	  0.060301, 0.058238, 0.055586, 0.052570, 0.049548, 0.047151, 0.046715, 0.047592, 0.048286, 0.047749, 0.042924, 0.035976, 0.029568, 0.023422, 0.021216, 0.021320
#*# 	  0.049123, 0.047423, 0.045582, 0.041998, 0.038748, 0.035150, 0.034214, 0.033432, 0.033480, 0.031833, 0.027062, 0.020948, 0.014437, 0.009476, 0.007311, 0.007482
#*# 	  0.041388, 0.040040, 0.038150, 0.033786, 0.029905, 0.025657, 0.023866, 0.022037, 0.020090, 0.017570, 0.012757, 0.007961, 0.002049, -0.002226, -0.004220, -0.004698
#*# 	  0.034373, 0.033329, 0.030581, 0.026741, 0.023135, 0.018079, 0.014612, 0.011871, 0.008681, 0.005700, 0.001221, -0.003499, -0.007923, -0.011712, -0.013809, -0.013767
#*# tension = 0.2
#*# min_x = 134.4
#*# algo = bicubic
#*# y_count = 8
#*# mesh_y_pps = 2
#*# min_y = 154.8
#*# x_count = 16
#*# max_y = 195.2
#*# mesh_x_pps = 2
#*# max_x = 215.6
#*#
#*# [beacon model default]
#*# model_coef = 1.4932847207145445,
#*# 	  1.813087807762665,
#*# 	  0.7366414453603123,
#*# 	  0.3563491168806203,
#*# 	  0.3852608157240816,
#*# 	  0.34424757540113665,
#*# 	  -0.26878256853592825,
#*# 	  -0.3108931011339748,
#*# 	  0.25378617562176914,
#*# 	  0.19890986381416514
#*# model_domain = 3.2251538094536715e-07,3.3508521240797756e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.134019
#*# model_offset = -0.74000
